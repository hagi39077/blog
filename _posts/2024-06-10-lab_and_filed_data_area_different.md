---
title: ラボデータとフィールドデータに相違が生じる理由について
author: NB
date: 2024-06-10
category: Core Webvitals
layout: post
mermaid: true
---

今の開発現場ではパフォーマンス改善の施策を行う場合、基本的に

1. 開発環境で修正
2. Lighthouse でスコアを確認
3. リリース
4. Page Spped Insights で計測

のサイクルを回している。
数値上改善はされているのだが、Lighthouse と PSI データに相違が生じることが多く、改善しきったと言えるのか？怪しい部分があった。
そこで、今回はラボデータとフィールドデータに相違が生じる理由について調べることにした。

## 前提

- ラボデータ

  - 開発者の PC で測定します
  - デバイスとネットワークを設定することでデータに一貫性と再現性を持たせることが目的です
  - 代表的なツールは Lighthouse になります

- フィールドデータ
  - サイトにアクセスした、Chrome ユーザから収集したデータです。
  - ユーザの実際のデバイスやネットワーク状態によって収集されるデータは異なります。
  - 代表的なツールは Page Speed Insihts

実際に PSI と Lighthouse を使用してみると、表示されるデータが大きくことなる場合があります。
ラボのデータを見るとサイトパフォーマンスが良好と表示されることもあれば、
フィールドデータでは改善が必要と表示されるこもあります。逆のパターンもあります。

下記例は、ラボデータとフィールドデータが Core Web Vitals のすべての指標で異なる可能性があることを示しています。
![PSI レポート結果](../assets/img/layout-Shift_sample.gif)

## 本題

### ラボデータとフィールドデータが異なる理由

前のセクションで説明した通り、ラボデータとフィールドデータは実際には全く異なるものを計測している。
フィールドデータには、アクセスユーザのネットワークやデバイスの条件などさまざまな要因が含まれる。
一方でラボデータでは関係する変数の数が制限されている。ラボテストの構成は以下の通り。
・１台のデバイス
・１つのネットワーク
・１つの地理的位置
ラボ環境は本番環境にデプロイする前のデバッグや機能のテストに役立ちますが、これらの要因を制御する場合、
あらゆる種類のネットワーク、デバイス機能、地理的位置にまたがって現実世界で見られるばらつきを明示的に表しているわけではない。
また、ページ上のスクロール、要素のタップといった実際のユーザの行動がパフォーマンスに及ぼす影響も把握できない。

ラボの条件と実際のユーザーの状況との間には乖離があるだけでなく、ラボとフィールド データを最大限に活用するために理解しておくべき微妙な違いや、その違いもいくつかある。

### LCP

ラボ環境で識別される LCP 要素は、ユーザがページにアクセスしたときに表示される LCP 要素と異なる場合がある。
特定のページに対して Lighthouse レポートを実行すると、毎回同じ LCP 要素が返される。
しかし、フィールドデータを見ると、各ページ訪問時に固有のさまざまな状況に応じて、さまざまな LCP 要素がある。
下記に示す要因は、異なる LCP 要素が決定される原因となる可能性がある。

- デバイスの画面サイズ。ビューポート内に表示される要素が異なるため。
- 特定の条件で表示されるコンテンツ。
  - 例えば、ユーザがログインしている場合に表示されている場合は、LCP 要素がユーザーごとに大きくことなる可能性がある。
- ユーザのシステムにインストールされているフォントセットは、ページ上のテキストのサイズに影響を与える可能性がある。
- ページの中央または下部の要素。
  - ラボテストは、通常ページのベース URL で実行されており、クエリやハッシュフラグメント、ブラウザバックによるスクロール位置などを考慮されていない。

#### キャッシュ状態が LCP に及ぼす影響

ラボテストでは通常、コールドキャッシュのあるページが読み込まれるが、実際のユーザがそのページにアクセスしたときに、リソースの一部がすでにキャッシュされている場合がある。
ユーザが初めてページを読み込むときは読み込みが遅くなる可能性があるが、ページにキャッシュが適切に構成されていれば、次にユーザーが戻ったときにすぐに読み込まれる可能性がある。
一部のラボツールでは、同じページを複数回実行することをサポートしている。
ただし、ラボツールで新規ユーザとリピートユーザによる実際のアクセスの割合を把握することはできない。
キャッシュが最適化されており、リピーターが多いサイトでは、実際の LCP はラボデータよりもはるかに良いこともある。

#### AMP or Signed Exchange の最適化

AMP や Signed Exchange（SXG）を使用するサイトは、Google 検索などのコンテンツアグリゲータによってプリロードできる。
これにより、プラットフォームからページにアクセスするユーザの読み込みパフォーマンスが大幅に向上する。
また、クロスオリジンのプリロードに加えて、サイト自体はサイト内の後続のページのコンテンツをプリロードできるため、それらのページの LCP も改善される可能性がある。
ただし、ラボツールは、こうした最適化による効果をシミュレートするものではなく、たとえ実施したとしても、Google 検索などのプラットフォームからのトラフィックの割合を他のソースと比較して把握することはできない。

#### ユーザーインタラクションが LCP に及ぼす影響

LCP はビューポート内の大きな画像またはテキストブロックのレンダリング時間を識別するが、その最大の要素はページが読み込まれるときや、
新しいコンテンツがビューポートに動的に追加されるときに変化する可能性がある。
ラボでは、ブラウザがページが完全に読み込まれるまで待ってから、LCP 要素を判断します。
フィールドでは、ユーザがページをスクロールまたは操作を行うと、ブラウザはより大きな要素のモニタリングを停止します。

これは理にかなっています。なぜなら、ユーザーは通常、ページが「読み込まれたように見える」まで操作を待機するからです。
また、ユーザーの操作後にビューポートに追加された要素は、ユーザの操作が原因で読み込まれた可能性があるため、考慮する必要がないです。

ただし、このことの意味するところは、あるページのフィールドデータは、そのページでのユーザーの行動によっては、ラボよりフィールドデータの方が LCP が短くなる場合があるということです。

### INP

#### INP には実際のユーザによる操作が必要

INP 指標は、ユーザーが実際にページ操作を選択した時点で、ユーザーインタラクションに対するページの応答性を測定するものです。
ラボテストでは、スクリプトのユーザーの行動をサポートするものであっても、ユーザーがいつページを操作するかを正確に予測できず、FID を正確に測定できないです。

#### TBT ではユーザ行動は考慮されない

ラボの合計ブロック時間（TBT）指標は、ページの読み込み中にメインスレッドがどの程度ブロックされるかを定量化して、INP の問題を診断することを目的としています。
同期的な JavaScript や他の集中的なレンダリング タスクが多いページでは、ユーザーが初めて操作したときにメインスレッドがブロックされる可能性が高くなる。ただし、JavaScript の実行が完了するまでユーザーがページの操作を待機すると、INP が非常に低くなる可能性があります。

ユーザーがページを操作するタイミングは、ページがインタラクティブに見えるかどうかによって大きく異なり、TBT では測定できません。

#### キャッシュ状態と bfcache が INP に及ぼす影響

適切なキャッシュによってフィールドの LCP が改善されるのと同様に、INP も向上します。

実際には、サイトの JavaScript がユーザーのキャッシュにすでに保存されている可能性があります。そのため、処理の時間を短縮し、遅延を小さくすることができます。

bfcache から復元されたページについても同様です。その場合、JavaScript はメモリから復元されるため、処理時間がほとんど、またはまったくない可能性があります。

### CLS

#### ユーザー インタラクションが CLS に及ぼす影響

ラボで測定した CLS では、スクロールせずに見える範囲と読み込み時に発生するレイアウト シフトのみが考慮されます。
実際の現場では、CLS はページ内の全ての要素に対してレイアウトシフトを考慮する必要があります。
これには、ユーザーのスクロールに伴ってシフトするコンテンツや、ユーザーとのインタラクションの後に発生する低速なネットワークリクエストへの対応も含まれます。
例えば、画像や iframe を height 指定なしで遅延ロードするページはよくあります。
ユーザーがページの各セクションにスクロールしたときにレイアウトがずれることもあります。
しかし、このようなシフトは、ユーザーがスクロールダウンした場合にのみ発生する可能性があり、ラボテストでは発見できないことがよくあります。

#### CLS に対するキャッシュ状態と bfcache の影響

読み込み中のレイアウトシフトの一般的な原因は、高さ指定のない画像と iframe と、ウェブフォントの読み込みが遅いことです。
どちらの問題も、ユーザーが初めてサイトにアクセスしたとき、キャッシュが空の場合に影響する可能性があります。
ページのリソースがキャッシュに保存されている場合、またはページ自体が bfcache から復元された場合、ブラウザは通常、画像やフォントのダウンロードを待たずにすぐにレンダリングできます。このため、フィールドの CLS 値がラボツールで報告される値よりも低くなる可能性があります。

## まとめ

原則として、特定のページにフィールド データとラボデータの両方がある場合は、作業の優先順位付けにフィールド データを使用する必要があります。
フィールド データは実際のユーザーが直面している状況を表すため、ユーザーが直面している問題や改善が必要な点を最も正確に把握できるからです。

逆に、フィールド データが全体的に良好なスコアを示していても、ラボデータからまだ改善の余地があると判断された場合は、さらに最適化できる方法を理解する価値があります。

また、フィールド データは実際のユーザーエクスペリエンスをキャプチャしますが、これはサイトを正常に読み込むことができるユーザーについてのみデータを表します。ラボデータは、サイトのリーチを拡大し、低速ネットワークやローエンド デバイスのユーザーがアクセスしやすくする機会を特定するのに役立ちます。

全体として、ラボデータとフィールド データは、効果的なパフォーマンス測定の重要な要素です。どちらにも長所と限界があり、1 つだけ使用していると、ユーザーエクスペリエンスを改善する機会を逃す可能性があります。

[Cumulative Layout Shift（CLS） web.dev][1].

[1]: https://web.dev/articles/cls?hl=ja
